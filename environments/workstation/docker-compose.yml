version: "3.8"

# DM-ISAAC-G1 Workstation Environment
# Follows IsaacLab Docker deployment approach
# https://isaac-sim.github.io/IsaacLab/main/source/deployment/docker.html
#
# IsaacLab v2.2.0 is built INTO the image (not mounted)
# Uses Isaac Sim 5.0.0 with NumPy < 2.0 for stability

services:
  dm-workstation:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ISAAC_SIM_VERSION: "5.0.0"
    image: dm-workstation:latest
    container_name: dm-workstation
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - DISPLAY=${DISPLAY:-:0}
      - ACCEPT_EULA=Y
      # GROOT server connection (DGX Spark)
      - GROOT_SERVER_HOST=${GROOT_SERVER_HOST:-192.168.1.237}
      - GROOT_SERVER_PORT=${GROOT_SERVER_PORT:-5555}
      # HuggingFace
      - HF_TOKEN=${HF_TOKEN}
      - HUGGING_FACE_HUB_TOKEN=${HF_TOKEN}
      # W&B
      - WANDB_API_KEY=${WANDB_API_KEY}
      # MuJoCo headless rendering
      - MUJOCO_GL=egl
      - PYOPENGL_PLATFORM=egl
    volumes:
      # Mount the dm-isaac-g1 repo (live code editing)
      - /home/datamentors/dm-isaac-g1:/workspace/dm-isaac-g1
      # Mount datasets and checkpoints (persistent storage)
      - /workspace/datasets:/workspace/datasets
      - /workspace/checkpoints:/workspace/checkpoints
      # NOTE: IsaacLab v2.2.0 is built into the image, not mounted
      # This ensures ./isaaclab.sh --install ran correctly during build
      # Mount Isaac-GR00T (for client code)
      - /workspace/Isaac-GR00T:/workspace/Isaac-GR00T
      # Mount unitree_sim_isaaclab (from /home/datamentors)
      - /home/datamentors/unitree_sim_isaaclab:/workspace/unitree_sim_isaaclab
      # MuJoCo Menagerie (persistent â€” avoids re-cloning on rebuild)
      - mujoco_menagerie:/workspace/mujoco_menagerie
      # X11 for GUI
      - /tmp/.X11-unix:/tmp/.X11-unix
      # GPU access
      - /dev/dri:/dev/dri
    ports:
      - "47995-48012:47995-48012"  # Isaac Sim streaming
      - "6006:6006"                 # TensorBoard
      - "5901:5901"                 # VNC
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

volumes:
  mujoco_menagerie:
