version: "3.8"

# DM-ISAAC-G1 Workstation — Unitree-based Docker Environment
#
# TWO-IMAGE STRATEGY:
#   dm-workstation-base  — Isaac Sim + IsaacLab + unitree stack (no GR00T)
#                          Pushed to ECR as the stable, cacheable base.
#   dm-workstation       — Extends base, adds GR00T inference deps via uv.
#                          Used for running GROOT inference on the workstation.
#
# Build commands:
#   # Base only (for ECR push):
#   docker compose -f docker-compose.unitree.yml build base
#
#   # Full inference image (extends base):
#   docker compose -f docker-compose.unitree.yml build groot
#
# ECR push (base):
#   source ../../.env
#   aws sso login --profile $AWS_PROFILE
#   aws ecr get-login-password --region $AWS_REGION --profile $AWS_PROFILE | \
#     docker login --username AWS --password-stdin $AWS_ECR_REGISTRY
#   docker tag dm-workstation-base:latest $AWS_ECR_REGISTRY/$AWS_ECR_REPO:base-latest
#   docker push $AWS_ECR_REGISTRY/$AWS_ECR_REPO:base-latest

x-common-env: &common-env
  NVIDIA_VISIBLE_DEVICES: all
  NVIDIA_DRIVER_CAPABILITIES: all
  ACCEPT_EULA: "Y"
  OMNI_KIT_ALLOW_ROOT: "1"
  GROOT_SERVER_HOST: ${GROOT_SERVER_HOST:-192.168.1.237}
  GROOT_SERVER_PORT: ${GROOT_SERVER_PORT:-5555}
  HF_TOKEN: ${HF_TOKEN}
  HUGGING_FACE_HUB_TOKEN: ${HF_TOKEN}
  WANDB_API_KEY: ${WANDB_API_KEY}
  GR00T_STATS: /workspace/checkpoints/groot_g1_inspire_9datasets/processor/statistics.json

x-common-volumes: &common-volumes
  - /home/datamentors/dm-isaac-g1:/workspace/dm-isaac-g1
  - /workspace/datasets:/workspace/datasets
  - /workspace/datasets_inspire:/workspace/datasets_inspire
  - /workspace/checkpoints:/workspace/checkpoints
  - /workspace/Isaac-GR00T:/workspace/Isaac-GR00T
  - /home/datamentors/unitree_sim_isaaclab:/workspace/unitree_sim_isaaclab
  - /tmp/.X11-unix:/tmp/.X11-unix
  - /dev/dri:/dev/dri

x-common-deploy: &common-deploy
  resources:
    reservations:
      devices:
        - driver: nvidia
          count: all
          capabilities: [gpu]

services:
  # --------------------------------------------------------
  # BASE image: Isaac Sim + IsaacLab + unitree stack
  # Stable, pushed to ECR. No GR00T.
  # --------------------------------------------------------
  base:
    build:
      context: .
      dockerfile: Dockerfile.unitree
      target: base
    image: dm-workstation-base:latest
    container_name: dm-workstation-base
    runtime: nvidia
    environment:
      <<: *common-env
      DISPLAY: ${DISPLAY:-:1}
    volumes: *common-volumes
    ports:
      - "47995-48012:47995-48012"
      - "6006:6006"
      - "5901:5901"
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true
    deploy: *common-deploy

  # --------------------------------------------------------
  # GROOT image: extends base, adds GR00T inference deps
  # Used for running inference against the DGX Spark GROOT server.
  # --------------------------------------------------------
  groot:
    build:
      context: .
      dockerfile: Dockerfile.unitree
      target: groot
    image: dm-workstation:latest
    container_name: dm-workstation
    runtime: nvidia
    environment:
      <<: *common-env
      DISPLAY: ${DISPLAY:-:1}
    volumes: *common-volumes
    ports:
      - "47995-48012:47995-48012"
      - "6006:6006"
      - "5901:5901"
    network_mode: host
    ipc: host
    stdin_open: true
    tty: true
    deploy: *common-deploy
